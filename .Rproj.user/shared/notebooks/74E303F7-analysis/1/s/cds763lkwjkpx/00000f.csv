"0","# Check if topic modeling produced results"
"0","if(!is.null(results$topics$model)) {"
"0","  topics <- results$topics$model"
"0","  "
"0","  # Create topic interpretations with meaningful names"
"0","  topic_interpretations <- data.frame("
"0","    topic = paste0(""X"", 1:ncol(topics$theta)),"
"0","    interpretation = c("
"0","      ""Exchange Deposits"", ""Arbitrage Activity"", ""Liquidations"","
"0","      ""Whale Transfers"", ""Retail Panic"", ""Institutional Activity"","
"0","      ""Cross-chain Bridges"", ""DEX Swaps"", ""Lending Platforms"","
"0","      ""Staking Withdrawals"""
"0","    )[1:ncol(topics$theta)]"
"0","  )"
"0","  "
"0","  # Get top 5 address pairs for each topic (instead of 10)"
"0","  top_terms <- data.frame()"
"0","  "
"0","  for(k in 1:ncol(topics$theta)) {"
"0","    # Get top pairs with higher weights"
"0","    top_pairs <- head(sort(topics$theta[,k], decreasing = TRUE), 5)"
"0","    "
"0","    # Create a more readable dataframe"
"0","    topic_terms <- data.frame("
"0","      topic_num = k,"
"0","      topic_name = topic_interpretations$interpretation[k],"
"0","      address_pair = names(top_pairs),"
"0","      weight = top_pairs"
"0","    )"
"0","    "
"0","    top_terms <- rbind(top_terms, topic_terms)"
"0","  }"
"0","  "
"0","  # Create simplified address labels"
"0","  top_terms <- top_terms %>%"
"0","    mutate("
"0","      # Create a simple ID for each address pair"
"0","      address_label = paste0(""Pair "", row_number()),"
"0","      # Create a percentage for weight"
"0","      weight_pct = weight * 100"
"0","    )"
"0","  "
"0","  # Create a cleaner bar chart"
"0","  ggplot(top_terms, aes(x = reorder(address_label, weight), y = weight_pct)) +"
"0","    geom_col(aes(fill = topic_name), show.legend = FALSE) +"
"0","    facet_wrap(~topic_name, scales = ""free_y"") +"
"0","    coord_flip() +"
"0","    labs(title = ""Top Address Pairs by Transaction Pattern"","
"0","         subtitle = ""Higher percentages indicate more characteristic address pairs for each pattern"","
"0","         x = """", y = ""Weight (%)"") +"
"0","    theme_minimal() +"
"0","    theme("
"0","      strip.background = element_rect(fill = ""lightblue"", color = NA),"
"0","      strip.text = element_text(face = ""bold""),"
"0","      panel.grid.minor = element_blank()"
"0","    )"
"0","  "
"0","  # Create a table of the actual addresses for reference"
"0","  address_reference <- top_terms %>%"
"0","    select(topic_name, address_label, address_pair, weight_pct) %>%"
"0","    arrange(topic_name, desc(weight_pct))"
"0","  "
"0","  # Print the reference table"
"0","  print(address_reference)"
"0","  "
"0","  # Topic prevalence over time"
"0","  topic_time <- data.frame("
"0","    date = as.Date(rownames(topics$omega)),"
"0","    topics$omega"
"0","  ) %>%"
"0","    pivot_longer("
"0","      cols = -date,"
"0","      names_to = ""topic"","
"0","      values_to = ""weight"""
"0","    ) %>%"
"0","    left_join(topic_interpretations, by = ""topic"")"
"0","  "
"0","  # Plot topic prevalence with proper labels"
"0","  ggplot(topic_time, aes(x = date, y = weight, color = interpretation)) +"
"0","    geom_line() +"
"0","    geom_vline(xintercept = as.Date(""2022-05-08""), linetype = ""dashed"") +"
"0","    geom_vline(xintercept = as.Date(""2022-05-15""), linetype = ""dashed"") +"
"0","    labs(title = ""Transaction Pattern Topics Over Time"","
"0","         x = ""Date"", y = ""Topic Weight"", color = ""Topic Type"") +"
"0","    theme_minimal()"
"0","  "
"0","  # Analyze topic prevalence by period"
"0","  topic_by_period <- topic_time %>%"
"0","    mutate("
"0","      period = case_when("
"0","        date < as.Date(""2022-05-08"") ~ ""pre_crash"","
"0","        date <= as.Date(""2022-05-15"") ~ ""crash_period"","
"0","        TRUE ~ ""post_crash"""
"0","      )"
"0","    ) %>%"
"0","    group_by(period, interpretation) %>%"
"0","    summarize("
"0","      avg_weight = mean(weight, na.rm = TRUE),"
"0","      .groups = ""drop"""
"0","    ) %>%"
"0","    arrange(period, desc(avg_weight))"
"0","  "
"0","  # Plot topic prevalence by period"
"0","  ggplot(topic_by_period, aes(x = reorder(interpretation, avg_weight), "
"0","                             y = avg_weight, fill = period)) +"
"0","    geom_bar(stat = ""identity"", position = ""dodge"") +"
"0","    coord_flip() +"
"0","    labs(title = ""Transaction Pattern Topics by Period"","
"0","         x = ""Topic Type"", y = ""Average Weight"", fill = ""Period"") +"
"0","    theme_minimal()"
"0","  "
"0","  # Create a heatmap of topic patterns over time"
"0","  topic_time_data <- data.frame("
"0","    date = as.Date(rownames(topics$omega)),"
"0","    topics$omega"
"0","  ) %>%"
"0","    pivot_longer("
"0","      cols = -date,"
"0","      names_to = ""topic"","
"0","      values_to = ""weight"""
"0","    ) %>%"
"0","    left_join(topic_interpretations, by = ""topic"") %>%"
"0","    # Add period markers"
"0","    mutate("
"0","      period = case_when("
"0","        date < as.Date(""2022-05-08"") ~ ""Pre-Crash"","
"0","        date <= as.Date(""2022-05-15"") ~ ""Crash Period"","
"0","        TRUE ~ ""Post-Crash"""
"0","      ),"
"0","      # Format date for better display"
"0","      date_label = format(date, ""%b %d"")"
"0","    )"
"0","  "
"0","  # Create heatmap"
"0","  ggplot(topic_time_data, aes(x = date, y = interpretation, fill = weight)) +"
"0","    geom_tile() +"
"0","    scale_fill_viridis_c(name = ""Weight"", option = ""plasma"") +"
"0","    geom_vline(xintercept = as.Date(""2022-05-08""), linetype = ""dashed"", color = ""white"") +"
"0","    geom_vline(xintercept = as.Date(""2022-05-15""), linetype = ""dashed"", color = ""white"") +"
"0","    labs(title = ""Transaction Pattern Heatmap Over Time"","
"0","         subtitle = ""Darker colors indicate stronger presence of a pattern"","
"0","         x = ""Date"", y = """") +"
"0","    scale_x_date(date_breaks = ""3 days"", date_labels = ""%b %d"") +"
"0","    theme_minimal() +"
"0","    theme("
"0","      axis.text.x = element_text(angle = 45, hjust = 1),"
"0","      panel.grid = element_blank(),"
"0","      legend.position = ""right"""
"0","    )"
"0","  "
"0","  # Add period annotations"
"0","  period_data <- data.frame("
"0","    period = c(""Pre-Crash"", ""Crash Period"", ""Post-Crash""),"
"0","    start_date = as.Date(c(""2022-04-28"", ""2022-05-08"", ""2022-05-16"")),"
"0","    end_date = as.Date(c(""2022-05-07"", ""2022-05-15"", ""2022-05-25""))"
"0","  )"
"0","  "
"0","  # Create period summary heatmap"
"0","  period_summary <- topic_time_data %>%"
"0","    group_by(period, interpretation) %>%"
"0","    summarize(avg_weight = mean(weight, na.rm = TRUE), .groups = ""drop"")"
"0","  "
"0","  ggplot(period_summary, aes(x = period, y = interpretation, fill = avg_weight)) +"
"0","    geom_tile() +"
"0","    scale_fill_viridis_c(name = ""Avg Weight"", option = ""plasma"") +"
"0","    geom_text(aes(label = sprintf(""%.3f"", avg_weight)), color = ""white"", size = 3) +"
"0","    labs(title = ""Transaction Patterns by Period"","
"0","         subtitle = ""Average weight of each pattern before, during, and after the crash"","
"0","         x = """", y = """") +"
"0","    theme_minimal() +"
"0","    theme("
"0","      panel.grid = element_blank(),"
"0","      axis.text.x = element_text(face = ""bold"")"
"0","    )"
"0","} else {"
"0","  cat(""Topic modeling results not available\n"")"
"0","  "
"0","  # If we have transaction data, perform simple pattern analysis"
"0","  if(exists(""transactions"")) {"
"0","    # Analyze transaction patterns by day"
"0","    daily_patterns <- transactions %>%"
"0","      group_by(token, date) %>%"
"0","      summarize("
"0","        transaction_count = n(),"
"0","        unique_senders = n_distinct(from_address),"
"0","        unique_receivers = n_distinct(to_address),"
"0","        avg_transaction = mean(value_numeric, na.rm = TRUE),"
"0","        median_transaction = median(value_numeric, na.rm = TRUE),"
"0","        max_transaction = max(value_numeric, na.rm = TRUE),"
"0","        .groups = ""drop"""
"0","      ) %>%"
"0","      mutate("
"0","        period = case_when("
"0","          date < as.Date(""2022-05-08"") ~ ""pre_crash"","
"0","          date <= as.Date(""2022-05-15"") ~ ""crash_period"","
"0","          TRUE ~ ""post_crash"""
"0","        )"
"0","      )"
"0","    "
"0","    # Plot transaction counts over time"
"0","    ggplot(daily_patterns, aes(x = date, y = transaction_count, color = token)) +"
"0","      geom_line() +"
"0","      geom_vline(xintercept = as.Date(""2022-05-08""), linetype = ""dashed"") +"
"0","      geom_vline(xintercept = as.Date(""2022-05-15""), linetype = ""dashed"") +"
"0","      labs(title = ""Daily Transaction Counts by Token"","
"0","           x = ""Date"", y = ""Transaction Count"")"
"0","  }"
"0","}"
