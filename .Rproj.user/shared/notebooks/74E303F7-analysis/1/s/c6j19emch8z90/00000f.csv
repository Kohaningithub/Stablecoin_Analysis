"0","# Prepare data for prediction modeling"
"0","prepare_prediction_data <- function() {"
"0","  # Check if we have stability data"
"0","  if(is.null(results$stability$daily)) {"
"0","    cat(""No stability data available for prediction modeling\n"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # Ensure required packages"
"0","  if(!require(zoo)) {"
"0","    install.packages(""zoo"")"
"0","    library(zoo)"
"0","  }"
"0","  "
"0","  # Prepare data with features"
"0","  stability_data <- results$stability$daily %>%"
"0","    # Create features"
"0","    group_by(token) %>%"
"0","    arrange(token, date) %>%"
"0","    mutate("
"0","      # Lag features (previous day's deviation)"
"0","      prev_deviation = lag(peg_deviation),"
"0","      # Rolling average (3-day)"
"0","      rolling_avg = rollmean(peg_deviation, k = 3, fill = NA, align = ""right""),"
"0","      # Volatility (rolling standard deviation)"
"0","      volatility = rollapply(peg_deviation, width = 3, FUN = sd, fill = NA, align = ""right""),"
"0","      # Day of week"
"0","      day_of_week = lubridate::wday(date),"
"0","      # Is weekend"
"0","      is_weekend = ifelse(day_of_week %in% c(1, 7), 1, 0),"
"0","      # Period indicator"
"0","      period_indicator = case_when("
"0","        date < as.Date(""2022-05-08"") ~ 0,  # pre-crash"
"0","        date <= as.Date(""2022-05-15"") ~ 1,  # crash"
"0","        TRUE ~ 2  # post-crash"
"0","      )"
"0","    ) %>%"
"0","    ungroup() %>%"
"0","    # Remove rows with NA (due to lagging)"
"0","    na.omit()"
"0","  "
"0","  return(stability_data)"
"0","}"
"0",""
"0","# Get prepared data"
"0","prediction_data <- prepare_prediction_data()"
"0",""
"0","# Show summary of prepared data"
"0","if(!is.null(prediction_data)) {"
"0","  cat(""Prepared data summary:\n"")"
"0","  prediction_data %>%"
"0","    group_by(token) %>%"
"0","    summarize("
"0","      observations = n(),"
"0","      date_range = paste(min(date), ""to"", max(date)),"
"0","      mean_deviation = mean(peg_deviation),"
"0","      .groups = ""drop"""
"0","    ) %>%"
"0","    knitr::kable()"
"0","}"
"1","Prepared data summary:
"
